{% extends 'vegefoods/layout.html' %}
{% load static %}
{% load call_method %}
{% load humanize %}
{% block links %}

{% endblock %}

{% block content %}


    <div class="home-slider owl-carousel" style="height: 252px; !important;">
        {% for c in carousels %}
            <div class="" style="background-image: url({{ c.image.url }});">
              <div class="container">
                <div class="row no-gutters slider-text align-items-center justify-content-center">
                  <div class="col-md-9 ftco-animate text-center" style="height: 252px; !important;">
                    <p class="breadcrumbs text-white"><span class="mr-2">
                        <a href="{% url 'Shoppy:shoppy-home' %}">Home</a></span>
                        <span class="mr-2">
                            <a href="#">How To Pay</a>
                        </span> <span></span>
                    </p>
                    <h1 class="mb-0 bread text-white">My How To Pay</h1>
                      <span class="text-white"></span>
                  </div>
                </div>
              </div>
            </div>
        {% endfor %}
    </div>

    <section class="ftco-section">
      <div class="container">
          <div class="col-xl-12 ftco-animate">
                <h3 class="mb-4 billing-heading">How To Pay</h3>
	          	<div class="row">
                    <div style="background-color: green; border-radius: 18px; box-shadow: 4px 3px 10px black;" class="payment_details pd1 p-5 row col-md-12 col-sm-12 col-xs-12 col-lg-12 col-xl-12">
                        <span class="ftco-animate  col-sm-12 col-md-4 col-lg-4 col-xl-4 d-flex flex-column align-items-center">
                            <h3 class="ftco-animate " style="color:white; font-size: 30px; font-weight: bolder">Total Orders: </h3><br>
                            <span style="color: white;" class="ftco-animate color-org">{{order_total.count}}</span>
                        </span>
                        <span class="ftco-animate  col-sm-12 col-md-4 col-lg-4 col-xl-4 mt-3 d-flex flex-column align-items-center">
                            <h3 class="ftco-animate " style="color:white; font-size: 30px; font-weight: bolder">Payment: </h3><br>
                            <span style="color: white;" class=" ftco-animate color-org">{{checkout.total|floatformat|intcomma}} Ksh</span>
                        </span>
                        <span class=  " ftco-animate col-sm-12 col-md-4 col-lg-4 col-xl-4 mt-3 d-flex flex-column align-items-center">
                            <h3 class="ftco-animate " style="color:white; font-size: 30px; font-weight: bolder">Order Number: </h3><br>
                            <span class="ftco-animate color-org" style="color:white;font-family: Arial;">{{checkout.reference_code}} </span>
                        </span>

                    </div>
                    <div class="payment_details pd2 col-md-12 col-sm-12 col-xs-12 col-lg-12 col-xl-12 py-4">
                        <div class="row d-flex justify-content-between">
                            <div class="col-sm-12 col-md-12 col-lg-5 col-xl-5">
                                <div class="mpesa_image row">
                                    <img style="width: 450px;" class="ftco-animate"  src="{% static 'img/MPESA-Logo2.png' %}" alt="">
                                </div>
                                <h4 class="text-capitalize mt-3 ftco-animate">Pay using Mpesa</h4>
                                <ol >
                                    <li style="font-size: 18px;" class="ftco-animate text-capitalize py-2 text-muted">open sim toolkit on your phone</li>
                                    <li style="font-size: 18px;" class="ftco-animate text-capitalize py-2 text-muted">Go To Mpesa menu</li>
                                    <li style="font-size: 18px;" class="ftco-animate text-capitalize py-2 text-muted">Select paybill</li>
                                    <li style="font-size: 18px;" class="ftco-animate text-capitalize py-2 text-muted">enter the paybill number on the input field</li>
                                    <li style="font-size: 18px;" class="ftco-animate text-capitalize py-2 text-muted">enter the order
                                         number (<a href="#">{{ checkout.reference_code }}</a>) as the the account name </li>
                                </ol>
                            </div>
                            <div class="d-flex flex-lg-column flex-xl-column flex-sm-row flex-md-row justify-content-center align-items-center">
                                <span style="border: 1px solid #6c6c6c; width: 1px; height: 100%;"></span>
                                    <span class="p-2" style="font-size: 20px;">OR</span>
                                <span style="border: 1px solid #6c6c6c; width: 1px; height: 100%;"></span>
                            </div>
                            <div class="col-sm-12 col-md-12 col-lg-5 col-xl-5 ">
                                <div class="h-50 mpesa_image row">
{#                                                <img src="{% static 'img/MPESA-Logo2.png' %}" alt="">#}
                                </div>
                                <h4 class="text-capitalize ftco-animate">pay using cash</h4>
                                <p class="text-muted ftco-animate" style="font-size: 18px;">You can pay in cash when you get the product(s) from the pic up station or on delivery.
                                    on payment, you will recieve your products(s) and a receipt.
                                </p>
                            </div>
                        </div>
                        <div class="col-sm-12 col-md-12" style="height: 100%;">
                            <h3 style="text-align: center;" class="text-capitalize mt-3 ftco-animate">OR</h3>
                            <h4 class="text-capitalize mt-3 ftco-animate">Pay using PayPal</h4>
                            <div class="row" style="display: flex; justify-content: center; align-items: center ; padding: 20px;">
                                <div id="paypal-button-container" style="display: flex; flex-direction: column; justify-content: flex-start; align-items: center;width: 100%; "></div>
                            </div>
                       </div>
                    </div>
                    <div class="row w-100">
                        <a class="product-button ml-auto ftco-animate" href="{% url 'Shoppy:shoppy-home' %}">Continue Shopping</a>
                    </div>
                </div>
          </div>
            <span id="checkout_id" hidden style="display:none">{{ checkout.id }}</span>
            <span id="checkout_id2" hidden style="display:none">{{ checkout.id }}</span>
          </div>
    </section> <!-- .section -->
{% endblock content %}
{% block scripts %}
        <script src="https://www.paypal.com/sdk/js?client-id=AYvT3OhFdk32s6G9Af6j-7YAOzrOcTLJ1e1l5FvIn_CapqQQyzSksAJaYM1nxRBBeMPEdfzI-xz1xxFy"></script>
    <script>
    $(document).ready(function () {
        let loc = window.location.origin + "/orderdetailspaypalpay/";
        let ch_id = $('#checkout_id').text();
        var dta = {
            'csrfmiddlewaretoken':csrftoken,
            'chek_id': Number(ch_id),
        }
        console.log(loc, ch_id)
        $.post(loc,dta,
               function(response){
                   {#console.log(response);#}
                   loadPayp(response)
               }
        );

    });
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    function loadPayp(res) {
        var currency = [108.1,108.2,108.3,108.4,108.5,108.6,108.7,108.8,108.9,108.10]
        const randomElement = currency[Math.floor(Math.random() * currency.length)];
        {#console.log(randomElement);#}
        var amm = res['ammount']
        var total = amm/randomElement;

        paypal.Buttons({
        style: {
            color:  'gold',
            shape:  'pill',
            label:  'pay',
            height: 40
        },
        // Set up the transaction
        createOrder: function(data, actions) {
            return actions.order.create({
                purchase_units: [{
                    amount: {
                        value: total.toFixed(2),
                    }
                }]
            });
        },

        // Finalize the transaction
        onApprove: function(data, actions) {
            return actions.order.capture().then(function(details) {
                completePayment(details)
            });
        }
    }).render('#paypal-button-container')
    }
    function completePayment(data){
        var ch_id = $('#checkout_id2').text();
        var url = window.location.origin+"/payment_complete/"+Number(ch_id)+"/";
        console.log(url, ch_id)
        $.ajax({
            processData: false,
            headers: {
                'Content-type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            type: 'POST',
            url: url,
            data: JSON.stringify(data),
            dataType: 'json',
            success: function(data){
                console.log(data)
                if (data['status'] === 'success' && data['payment'] === 'done' ){
                    swal.fire({
                        title: "Success!",
                        text: 'Payment done',
                        type: "success",
                        confirmButtonText: "Ok"
                    });
                    window.location = window.location.origin;
                }
                else if(data['status'] === 'error' && data['payment'] === 'reversed' ){
                     swal.fire({
                        title: "Error",
                        text: 'Payment not done',
                        type: "error",
                        confirmButtonText: "Ok"
                     });
                }
            },
            error: function(){

            },

        });
   }
    </script>

{% endblock %}